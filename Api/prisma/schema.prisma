generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id                  Int                @id @default(autoincrement())
  ra                  String             @unique
  nome                String
  senha               String
  serie               String
  curso               String             @default("matematica")
  status              String             @default("ativo")
  pontuacao           Int                @default(0)
  desafiosCompletados Int                @default(0)
  criadoEm            DateTime           @default(now())
  atualizadoEm        DateTime           @updatedAt

  historicoDesafios   HistoricoDesafio[]
  mensagensChat       MensagemChat[]
  conversasComoUsuario1  Conversa[]           @relation("conversas_usuario1")
  conversasComoUsuario2  Conversa[]           @relation("conversas_usuario2")
  mensagensEnviadas      MensagemPrivada[]
  
  // Relações de amizade
  amizadesComoUsuario  Amizade[]           @relation("amizades_usuario")
  amizadesComoAmigo    Amizade[]           @relation("amizades_amigo")
  notificacoesRecebidas NotificacaoAmizade[] @relation("notificacoes_usuario")
  notificacoesEnviadas  NotificacaoAmizade[] @relation("notificacoes_remetente")
  
  progressoAulas      ProgressoAula[]
  progressoModulos    ProgressoModulo[]
  progressoCursos     ProgressoCurso[]

  solicitacoes       SolicitacaoAutorizacao[]  @relation("SolicitacoesUsuario")
  autorizacoes       AutorizacaoAula[]         @relation("UsuarioAutorizacoes")
  adminSolicitacoes  SolicitacaoAutorizacao[]  @relation("AdminSolicitacoes")
  adminAutorizacoes  AutorizacaoAula[]         @relation("AdminAutorizacoes")
  logsUsuario        LogAutorizacao[]          @relation("LogsUsuario")
  logsAdmin          LogAutorizacao[]          @relation("LogsAdmin")

  @@map("Usuario")
}

model Video {
  id        Int      @id @default(autoincrement())
  titulo    String
  materia   String
  categoria String
  url       String    
  iv        String?   
  tag       String?   
  descricao String?
  duracao   Int
  criadoEm  DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@map("videos")
}
model Desafio {
  id                Int                @id @default(autoincrement())
  titulo            String
  descricao         String?
  materia           String
  nivel             String
  pontuacao         Int                @default(20)
  duracao           Int                @default(15)
  status            String             @default("ativo")
  maxTentativas     Int                @default(1)
  dataInicio        DateTime?
  dataFim           DateTime?
  
  perguntas         PerguntaDesafio[]
  historico         HistoricoDesafio[]
  
  criadoEm          DateTime           @default(now())
  atualizadoEm      DateTime           @updatedAt
  
  @@map("desafios")
}

model PerguntaDesafio {
  id                Int      @id @default(autoincrement())
  pergunta          String
  alternativaA      String
  alternativaB      String
  alternativaC      String
  alternativaD      String
  correta           Int
  explicacao        String?
  ordem             Int      @default(1)
  ativo             Boolean  @default(true)
  
  desafioId         Int
  desafio           Desafio  @relation(fields: [desafioId], references: [id], onDelete: Cascade)
  
  criadoEm          DateTime @default(now())
  atualizadoEm      DateTime @updatedAt
  
  @@map("perguntas_desafio")
}

model HistoricoDesafio {
  id                Int      @id @default(autoincrement())
  pontuacaoGanha    Int
  acertos           Int
  totalPerguntas    Int
  porcentagemAcerto Float
  dataConclusao     DateTime @default(now())
  
  usuarioId         Int
  desafioId         Int
  usuario           Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  desafio           Desafio  @relation(fields: [desafioId], references: [id], onDelete: Cascade)
  
  criadoEm          DateTime @default(now())
  
  @@map("historico_desafios")
}

// ========== MODELOS DE CURSOS SIMPLIFICADOS ========== //

model Curso {
  id        Int      @id @default(autoincrement())
  titulo    String
  descricao String?
  materia   String
  categoria String
  nivel     String
  duracao   Int
  imagem    String?
  ativo     Boolean  @default(true)
  
  modulos   Modulo[]
  progressos ProgressoCurso[]

  configuracao  ConfiguracaoCurso?  
  solicitacoes  SolicitacaoAutorizacao[]
  autorizacoes  AutorizacaoAula[]

  criadoEm  DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  
  @@map("cursos")
}

model Modulo {
  id        Int      @id @default(autoincrement())
  titulo    String
  descricao String?
  ordem     Int      @default(1)
  ativo     Boolean  @default(true)
  
  cursoId   Int
  curso     Curso    @relation(fields: [cursoId], references: [id], onDelete: Cascade)
  aulas     Aula[]

  progressos ProgressoModulo[]

  solicitacoes  SolicitacaoAutorizacao[]
  autorizacoes  AutorizacaoAula[]

  criadoEm  DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  
  @@map("modulos")
}

model Aula {
  id        Int      @id @default(autoincrement())
  titulo    String
  descricao String?
  conteudo  String?
  videoUrl  String?  
  videoIv   String?  
  videoTag  String?   
  duracao   Int      @default(15)
  ordem     Int      @default(1)
  ativo     Boolean  @default(true)
  
  moduloId  Int
  modulo    Modulo   @relation(fields: [moduloId], references: [id], onDelete: Cascade)
  
  progressos ProgressoAula[]

  solicitacoes  SolicitacaoAutorizacao[]
  autorizacoes  AutorizacaoAula[]

  criadoEm  DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  
  @@map("aulas")
}

// ========== SISTEMA DE PROGRESSO ========== //

model ProgressoAula {
  id             Int      @id @default(autoincrement())
  usuarioId      Int
  aulaId         Int
  concluida      Boolean  @default(false)
  dataConclusao  DateTime?
  criadoEm       DateTime @default(now())
  atualizadoEm   DateTime @updatedAt

  usuario        Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  aula           Aula     @relation(fields: [aulaId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, aulaId])
  @@map("progresso_aulas")
}

model ProgressoModulo {
  id             Int      @id @default(autoincrement())
  usuarioId      Int
  moduloId       Int
  progresso      Int      @default(0) // 0-100
  criadoEm       DateTime @default(now())
  atualizadoEm   DateTime @updatedAt

  usuario        Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  modulo         Modulo   @relation(fields: [moduloId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, moduloId])
  @@map("progresso_modulos")
}

model ProgressoCurso {
  id             Int      @id @default(autoincrement())
  usuarioId      Int
  cursoId        Int
  progresso      Int      @default(0) // 0-100
  criadoEm       DateTime @default(now())
  atualizadoEm   DateTime @updatedAt

  usuario        Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  curso          Curso    @relation(fields: [cursoId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, cursoId])
  @@map("progresso_cursos")
}

model MensagemChat {
  id        Int      @id @default(autoincrement())
  usuarioId Int?     
  usuario   Usuario? @relation(fields: [usuarioId], references: [id], onDelete: Cascade) 
  conteudo  String
  tipo      String   @default("texto")
  timestamp DateTime @default(now())
  
  @@map("mensagens_chat")
}

model Amizade {
  id          Int      @id @default(autoincrement())
  usuarioId   Int
  amigoId     Int
  status      String   @default("pendente") // "pendente", "aceito", "bloqueado"
  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  
  usuario     Usuario  @relation("amizades_usuario", fields: [usuarioId], references: [id], onDelete: Cascade)
  amigo       Usuario  @relation("amizades_amigo", fields: [amigoId], references: [id], onDelete: Cascade)
  
  @@unique([usuarioId, amigoId])
  @@map("amizades")
}

model NotificacaoAmizade {
  id          Int      @id @default(autoincrement())
  tipo        String   // "solicitacao_amizade", "aceito_amizade"
  usuarioId   Int
  remetenteId Int
  lida        Boolean  @default(false)
  criadoEm    DateTime @default(now())
  
  usuario     Usuario  @relation("notificacoes_usuario", fields: [usuarioId], references: [id], onDelete: Cascade)
  remetente   Usuario  @relation("notificacoes_remetente", fields: [remetenteId], references: [id], onDelete: Cascade)
  
  @@map("notificacoes_amizade")
}

model Conversa {
  id          Int         @id @default(autoincrement())
  usuario1Id  Int
  usuario2Id  Int
  criadoEm    DateTime    @default(now())
  atualizadoEm DateTime   @updatedAt
  
  usuario1    Usuario     @relation("conversas_usuario1", fields: [usuario1Id], references: [id], onDelete: Cascade)
  usuario2    Usuario     @relation("conversas_usuario2", fields: [usuario2Id], references: [id], onDelete: Cascade)
  mensagens   MensagemPrivada[]
  
  @@unique([usuario1Id, usuario2Id])
  @@map("conversas")
}

model MensagemPrivada {
  id          Int         @id @default(autoincrement())
  conversaId  Int
  remetenteId Int
  conteudo    String
  lida        Boolean     @default(false)
  criadoEm    DateTime    @default(now())
  
  conversa    Conversa    @relation(fields: [conversaId], references: [id], onDelete: Cascade)
  remetente   Usuario     @relation(fields: [remetenteId], references: [id], onDelete: Cascade)
  
  @@map("mensagens_privadas")
}

model ConfiguracaoCurso {
  id              Int      @id @default(autoincrement())
  cursoId         Int      @unique
  modoProgresso   String   @default("auto") // auto, controlado, misto
  permiteAvancar  Boolean  @default(true)
  requerAutorizacao Boolean @default(false)
  limiteDiasAula  Int?
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt
  
  curso           Curso    @relation(fields: [cursoId], references: [id], onDelete: Cascade)
}

model SolicitacaoAutorizacao {
  id              Int      @id @default(autoincrement())
  usuarioId       Int
  cursoId         Int
  aulaId          Int
  moduloId        Int?
  motivo          String?
  motivoRejeicao  String?
  status          String   @default("pendente") // pendente, aprovado, rejeitado
  autorizacaoId   Int?
  adminId         Int?
  criadoEm        DateTime @default(now())
  processadoEm    DateTime?
  atualizadoEm    DateTime @updatedAt
  
  usuario  Usuario @relation("SolicitacoesUsuario", fields: [usuarioId], references: [id])
  curso    Curso   @relation(fields: [cursoId], references: [id])
  aula     Aula    @relation(fields: [aulaId], references: [id])
  modulo   Modulo? @relation(fields: [moduloId], references: [id])
  admin    Usuario? @relation("AdminSolicitacoes", fields: [adminId], references: [id])
  autorizacao   AutorizacaoAula? @relation(fields: [autorizacaoId], references: [id])

  @@index([usuarioId])
  @@index([cursoId])
  @@index([aulaId])
  @@index([status])
  @@index([criadoEm])
}

model AutorizacaoAula {
  id             Int      @id @default(autoincrement())
  tipo           String   // "liberar_aula", "liberar_modulo", "liberar_todas", "bloquear_progresso"
  usuarioId      Int
  cursoId        Int
  aulaId         Int?
  moduloId       Int?
  motivo         String?
  dataExpiracao  DateTime?
  adminId        Int
  ativo          Boolean  @default(true)
  criadoEm       DateTime @default(now())
  atualizadoEm   DateTime @updatedAt
  
  usuario   Usuario  @relation("UsuarioAutorizacoes", fields: [usuarioId], references: [id], onDelete: Cascade)
  curso     Curso    @relation(fields: [cursoId], references: [id], onDelete: Cascade)
  aula      Aula?    @relation(fields: [aulaId], references: [id], onDelete: Cascade)
  modulo    Modulo?  @relation(fields: [moduloId], references: [id], onDelete: Cascade)
  admin     Usuario  @relation("AdminAutorizacoes", fields: [adminId], references: [id])

  solicitacoes SolicitacaoAutorizacao[]

  logs  LogAutorizacao[]


  @@index([usuarioId])
  @@index([cursoId])
  @@index([aulaId])
  @@index([moduloId])
  @@index([ativo])
  @@index([dataExpiracao])
  @@map("autorizacoes_aula")
}

// Adicione estes modelos se não existirem no seu schema
model SistemaAutorizacao {
  id              Int      @id @default(autoincrement())
  bloqueioTotal   Boolean  @default(true)
  modo            String   @default("progressivo") // "progressivo", "total", "livre"
  mensagem        String?
  atualizadoEm    DateTime @updatedAt
  atualizadoPor   Int?
  
  @@map("sistema_autorizacao")
}

model LogAutorizacao {
  id              Int      @id @default(autoincrement())
  tipo            String   // "criada", "revogada", "expirada"
  autorizacaoId   Int
  usuarioId       Int
  adminId         Int?
  detalhes        Json?
  criadoEm        DateTime @default(now())
  
  autorizacao     AutorizacaoAula @relation(fields: [autorizacaoId], references: [id])
  
  usuario         Usuario  @relation("LogsUsuario", fields: [usuarioId], references: [id])
  admin           Usuario? @relation("LogsAdmin", fields: [adminId], references: [id])
  
  @@map("log_autorizacao")
}


